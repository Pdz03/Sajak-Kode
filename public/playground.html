<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kanvas Kode - Sajak Kode</title>
    <link rel="icon" type="image/png" href="/images/favicon.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/dracula.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/xml/xml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/css/css.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/javascript/javascript.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;600&family=Inter:wght@400;600&family=Playfair+Display:ital,wght@1,500&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: { extend: { colors: { 'sajak-dark': '#0f172a', 'sajak-card': '#1e293b', 'sajak-accent': '#2dd4bf' } } }
        }
    </script>
    <style>
        .CodeMirror { height: 100%; font-family: 'Fira Code', monospace; font-size: 13px; }
        /* Style untuk Palette Warna */
        .color-chip {
            width: 40px; height: 40px; border-radius: 8px; cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s; border: 2px solid rgba(255,255,255,0.1);
            position: relative;
        }
        .color-chip:hover { transform: scale(1.1); box-shadow: 0 0 10px rgba(255,255,255,0.3); z-index: 10; }
        .color-chip:active { transform: scale(0.95); }
        
        /* Tooltip copy */
        .color-chip::after {
            content: 'Copy'; position: absolute; bottom: -25px; left: 50%; transform: translateX(-50%);
            background: black; color: white; font-size: 10px; padding: 2px 6px; rounded: 4px;
            opacity: 0; transition: opacity 0.2s; pointer-events: none;
        }
        .color-chip:hover::after { opacity: 1; }

        /* Lainnya */
        .canvas-frame {
            width: 400px; height: 300px; background: white; 
            overflow: hidden; position: relative; box-shadow: 0 0 20px rgba(0,0,0,0.5);
            flex-shrink: 0; /* Agar tidak gepeng */
        }
        .console-log { border-bottom: 1px solid #334155; padding: 4px 8px; font-family: 'Fira Code', monospace; font-size: 12px; }
        .console-error { color: #ef4444; background: #451a1a; }
    </style>
</head>

<body class="bg-sajak-dark text-slate-300 font-sans flex flex-col md:h-screen md:overflow-hidden h-auto overflow-auto">

    <header class="h-14 bg-sajak-card border-b border-slate-700 flex items-center justify-between px-4 shrink-0 sticky top-0 z-30 shadow-lg">
        <div class="flex items-center gap-3">
            <a href="/" class="flex items-center gap-2 group">
                <div class="w-8 h-8 flex items-center justify-center bg-sajak-card rounded border border-slate-600">
                   <img src="/images/logo.png" alt="Logo" class="w-full h-full object-contain p-1">
                </div>
                <span class="font-serif font-bold text-white text-lg hidden sm:inline">Kanvas<span class="text-sajak-accent">Kode</span></span>
            </a>
            
            <div id="battle-controls" class="hidden flex items-center gap-2 ml-4 border-l border-slate-600 pl-4">
                <span class="text-xs text-slate-400 font-mono hidden md:inline">TARGET:</span>
                <select id="target-selector" onchange="loadTarget(this.value)" class="bg-slate-800 text-white text-xs py-1 px-2 rounded border border-slate-600 focus:border-sajak-accent outline-none max-w-[150px] md:max-w-xs">
                    <option value="">-- Pilih Tantangan --</option>
                </select>
            </div>
        </div>

        <div class="flex gap-3 items-center">
            <button onclick="toggleMode()" id="mode-btn" class="text-xs font-bold px-3 py-1.5 rounded bg-slate-700 hover:bg-slate-600 transition flex items-center gap-2 border border-slate-500">
                <i class="fa-solid fa-table-columns"></i> <span class="hidden sm:inline">Mode Normal</span>
            </button>
            <span id="save-status" class="text-xs text-slate-500 font-mono hidden md:inline-block">Saved</span>
            <button onclick="runCode(true)" class="bg-sajak-accent text-sajak-dark px-5 py-1.5 rounded-full font-bold text-sm hover:bg-teal-300 transition shadow-[0_0_15px_rgba(45,212,191,0.3)] active:scale-95">
                <i class="fa-solid fa-play"></i> RUN
            </button>
        </div>
    </header>

    <div class="flex-grow flex flex-col md:flex-row md:h-[calc(100vh-3.5rem)] h-auto relative" id="main-container">
        
        <div id="left-col" class="w-full md:w-[35%] flex flex-col border-r border-slate-700 bg-[#282a36] relative min-w-[200px]">
            <div id="resizer" class="hidden md:block absolute right-0 top-0 bottom-0 w-1 bg-transparent hover:bg-sajak-accent cursor-col-resize z-50"></div>

            <div class="h-[200px] md:h-auto md:flex-1 flex flex-col min-h-0 border-b border-slate-700 relative">
                <div class="bg-slate-800/50 px-3 py-1 text-xs font-mono font-bold text-orange-400 border-b border-white/5">HTML</div>
                <div class="flex-grow overflow-hidden relative"><textarea id="html-code"></textarea></div>
            </div>
            <div class="h-[250px] md:h-auto md:flex-[1.5] flex flex-col min-h-0 border-b border-slate-700 relative">
                <div class="bg-slate-800/50 px-3 py-1 text-xs font-mono font-bold text-blue-400 border-b border-white/5">CSS</div>
                <div class="flex-grow overflow-hidden relative"><textarea id="css-code"></textarea></div>
            </div>
            <div class="h-[100px] md:h-auto md:flex-[0.5] flex flex-col min-h-0 relative">
                <div class="bg-slate-800/50 px-3 py-1 text-xs font-mono font-bold text-yellow-400 border-b border-white/5">JS</div>
                <div class="flex-grow overflow-hidden relative"><textarea id="js-code"></textarea></div>
            </div>
        </div>

        <div class="w-full md:flex-1 bg-[#0f172a] relative flex flex-col min-h-[400px]">
            
            <div id="normal-preview" class="flex-1 relative w-full h-full bg-white hidden">
                <iframe id="preview-frame" class="w-full h-full border-0"></iframe>
            </div>

            <div id="battle-preview" class="flex-1 w-full h-full flex flex-col xl:flex-row items-center justify-center gap-8 p-4 bg-[#0f172a] overflow-auto">
                
                <div class="flex flex-col items-center gap-2">
                    <span class="text-xs font-mono text-sajak-accent tracking-widest">OUTPUT KAMU</span>
                    <div class="canvas-frame">
                        <iframe id="battle-frame" class="w-full h-full border-0"></iframe>
                    </div>
                </div>

                <div class="flex flex-col items-center gap-2">
                    <span class="text-xs font-mono text-blue-400 tracking-widest">TARGET</span>
                    
                    <div class="canvas-frame bg-slate-800 flex items-center justify-center group relative">
                        <img id="target-img" src="" class="w-full h-full object-cover hidden" alt="Target">
                        <div id="no-target-msg" class="text-slate-500 text-xs text-center px-4">
                            <i class="fa-solid fa-arrow-up text-2xl mb-2 animate-bounce"></i><br>
                            Pilih Tantangan<br>di Pojok Kiri Atas
                        </div>
                    </div>

                    <div id="color-palette" class="flex gap-2 mt-2 h-10 w-full justify-center">
                        </div>
                </div>

            </div>

            <div id="console-container" class="h-40 border-t border-slate-700 bg-[#0f172a] hidden overflow-auto font-mono text-xs text-slate-300 p-2"></div>
        </div>
    </div>

    <script>
        // --- CONFIG & STATE ---
        let isBattleMode = false;
        let solutionsData = []; 
        
        const editorConfig = { theme: "dracula", lineNumbers: true, tabSize: 2 };
        const htmlEditor = CodeMirror.fromTextArea(document.getElementById("html-code"), { ...editorConfig, mode: "xml" });
        const cssEditor = CodeMirror.fromTextArea(document.getElementById("css-code"), { ...editorConfig, mode: "css" });
        const jsEditor = CodeMirror.fromTextArea(document.getElementById("js-code"), { ...editorConfig, mode: "javascript" });

        // --- CORE: RUN CODE ---
        function runCode() {
            const html = htmlEditor.getValue();
            let css = cssEditor.getValue();
            const js = jsEditor.getValue();

            const frameId = isBattleMode ? "battle-frame" : "preview-frame";
            const frame = document.getElementById(frameId);
            const doc = frame.contentDocument || frame.contentWindow.document;

            doc.open();

            if (isBattleMode) {
                // ðŸ”¥ ANTI-ROTASI BODY FIX ðŸ”¥
                // Ganti selector 'body' jadi '.user-body' agar frame tidak ikut miring
                const safeCss = css.replace(/(^|[\s,])body\s*\{/g, '$1.user-body {');

                doc.write(`
                    <style>
                        /* Frame Utama Iframe */
                        body { margin: 0; padding: 0; overflow: hidden; background: #fff; width: 100%; height: 100%; }
                        
                        /* Kotak Simulasi Body User */
                        .user-body {
                            width: 100%; height: 100%; margin: 0;
                            display: flex; justify-content: center; align-items: center; 
                            /* Mencegah properti user merusak frame luar */
                            transform-origin: center;
                        }
                    </style>
                    
                    <div class="user-body">
                        <style>${safeCss}</style>
                        ${html}
                    </div>
                `);
            } else {
                // MODE NORMAL: Render biasa
                doc.write(html + `<style>${css}</style>` + `<script>${js}<\/script>`);
            }
            doc.close();
            document.getElementById('save-status').innerText = "Saved";
        }

        // --- LOAD DATA ---
        
        async function fetchSolutionList() {
            try {
                const res = await fetch('/api/solutions');
                solutionsData = await res.json();
                
                const selector = document.getElementById('target-selector');
                solutionsData.sort((a,b) => a.targetNumber - b.targetNumber);
                
                solutionsData.forEach(sol => {
                    const opt = document.createElement('option');
                    opt.value = sol._id;
                    opt.text = `#${sol.targetNumber} - ${sol.title}`;
                    selector.appendChild(opt);
                });
            } catch(e) { console.error("Gagal load list", e); }
        }

        function loadTarget(id) {
            const sol = solutionsData.find(s => s._id === id);
            const img = document.getElementById('target-img');
            const msg = document.getElementById('no-target-msg');
            const palette = document.getElementById('color-palette');

            if(sol) {
                // 1. Tampilkan Gambar
                img.src = sol.image;
                img.classList.remove('hidden');
                msg.classList.add('hidden');

                // 2. Generate Palet Warna
                palette.innerHTML = ''; // Reset
                if (sol.colors && sol.colors.length > 0) {
                    sol.colors.forEach(color => {
                        const chip = document.createElement('div');
                        chip.className = 'color-chip';
                        chip.style.backgroundColor = color;
                        chip.title = `Klik untuk copy: ${color}`;
                        
                        // Copy Logic
                        chip.onclick = () => {
                            navigator.clipboard.writeText(color);
                            // Efek Visual
                            chip.style.transform = 'scale(0.9)';
                            setTimeout(() => chip.style.transform = 'scale(1)', 100);
                        };
                        palette.appendChild(chip);
                    });
                } else {
                    palette.innerHTML = '<span class="text-xs text-slate-600 italic mt-2">Warna tidak tersedia</span>';
                }

                // 3. Masukkan Kode (Opsional: Kalau mau otomatis load kode solusi)
                // cssEditor.setValue(sol.code || "");
                // htmlEditor.setValue("<div></div>");
                // runCode();
            } else {
                img.classList.add('hidden');
                msg.classList.remove('hidden');
                palette.innerHTML = '';
            }
        }

        async function checkUrlParams() {
            const params = new URLSearchParams(window.location.search);
            const id = params.get('id');

            await fetchSolutionList();

            if (id) {
                // --- MODE BATTLE (Dari URL) ---
                toggleMode(true);
                document.getElementById('target-selector').value = id;
                
                // Cari data dan load
                const sol = solutionsData.find(s => s._id === id);
                if (sol) {
                    loadTarget(id);
                    // Load kode ke editor
                    cssEditor.setValue(sol.code || "");
                    htmlEditor.setValue("<div></div>"); 
                    runCode();
                }
            } else {
                // --- MODE NORMAL (PUITIS KEMBALI) ---
                toggleMode(false); 
                
                // Kembalikan Template Puitis
                htmlEditor.setValue(
`<div class="empty-space">
  <div class="spinner-box"></div>
  <h1 class="title">Sajak Kode</h1>
  <p class="poetic-text">"Bebas bersajak di ruang hampa ini..."</p>
</div>`
                );
                
                cssEditor.setValue(
`body {
  margin: 0;
  height: 100vh;
  display: flex;
  justify-content: center;
  align-items: center;
  background-color: #ffffff;
  font-family: 'Inter', sans-serif;
  color: #0f172a;
}
.empty-space { text-align: center; }
.spinner-box {
  width: 60px; height: 60px;
  background: #2dd4bf; margin: 0 auto 24px;
  border-radius: 12px;
  animation: sajakSpin 3s infinite cubic-bezier(0.4, 0, 0.2, 1);
}
.title {
  font-size: 2rem; font-weight: 800; margin: 0 0 8px;
  font-family: 'Playfair Display', serif;
}
.poetic-text {
  font-size: 1.1rem; color: #64748b; font-style: italic;
  font-family: 'Playfair Display', serif;
}
@keyframes sajakSpin {
  0% { transform: rotate(0deg) scale(1); }
  50% { transform: rotate(180deg) scale(0.8); border-radius: 50%; }
  100% { transform: rotate(360deg) scale(1); }
}`
                );
                
                jsEditor.setValue(`console.log("Ruang hampa siap dilukis.");`);
                
                runCode();
            }
        }

        // --- UI LOGIC ---
        function toggleMode(forceBattle = null) {
            if (forceBattle !== null) isBattleMode = !forceBattle;
            isBattleMode = !isBattleMode;

            const normalView = document.getElementById('normal-preview');
            const battleView = document.getElementById('battle-preview');
            const btn = document.getElementById('mode-btn');
            const controls = document.getElementById('battle-controls');

            if (isBattleMode) {
                // Masuk Battle Mode
                normalView.classList.add('hidden');
                battleView.classList.remove('hidden');
                controls.classList.remove('hidden');
                btn.innerHTML = '<i class="fa-solid fa-code"></i> <span class="hidden sm:inline">Mode Normal</span>';
                btn.classList.replace('bg-slate-700', 'bg-blue-600');
                
                // Jika editor masih template puitis, bersihkan untuk battle
                if(htmlEditor.getValue().includes("empty-space")) {
                    cssEditor.setValue("body {\n  background: #191919;\n  display: flex;\n  justify-content: center;\n  align-items: center;\n}\ndiv {\n  width: 100px;\n  height: 100px;\n  background: #dd6b4d;\n}");
                    htmlEditor.setValue("<div></div>");
                }
            } else {
                // Masuk Normal Mode
                battleView.classList.add('hidden');
                normalView.classList.remove('hidden');
                controls.classList.add('hidden');
                btn.innerHTML = '<i class="fa-solid fa-crosshairs"></i> <span class="hidden sm:inline">Mode Battle</span>';
                btn.classList.replace('bg-blue-600', 'bg-slate-700');
            }
            runCode();
        }

        // Logic Resizer dan Auto Run tetap sama...
        const resizer = document.getElementById('resizer');
        const leftCol = document.getElementById('left-col');
        let isResizing = false;
        resizer.addEventListener('mousedown', () => { isResizing = true; document.body.style.cursor = 'col-resize'; document.querySelectorAll('iframe').forEach(i => i.style.pointerEvents = 'none'); });
        document.addEventListener('mousemove', (e) => {
            if(!isResizing) return;
            leftCol.style.width = (e.clientX / window.innerWidth * 100) + '%';
        });
        document.addEventListener('mouseup', () => { isResizing = false; document.body.style.cursor = ''; document.querySelectorAll('iframe').forEach(i => i.style.pointerEvents = 'auto'); });

        let timeout;
        const autoRun = () => { clearTimeout(timeout); timeout = setTimeout(runCode, 800); };
        htmlEditor.on("change", autoRun); cssEditor.on("change", autoRun); jsEditor.on("change", autoRun);

        // START
        checkUrlParams();

    </script>
</body>
</html>